# MIF01 - TP Remise en route JAVA

**Objectif :**

Il vous est demand√© de mettre en place quelques classes pour vous remettre en
t√™te les grands principes de la programmation orient√©e objet : messages et
collaboration entre objets, attributs et m√©thodes, constructeurs, h√©ritage, etc.
Pour cela, vous manipulerez un outil de gestion de donn√©es de sant√©s, inspir√© du
service https://www.monespacesante.fr/ d√©ploy√© par l'assurance maladie fran√ßaise
en 2022.

Votre travail servira de base aux TPs suivants qui feront l'objet d'une note
globale (voir le fichier [projet-note.md](projet-note.md) pour les consignes sur
l'ensemble du projet). Le travail se fait en bin√¥mes (malus sur la note pour les
√©tudiants travaillant seul). Si vous ne trouvez pas de bin√¥me, utilisez le canal
de discussion
[#mif01-2022/cherche-binome](https://go.rocket.chat/invite?host=chat-info.univ-lyon1.fr&path=invite%2F5pcnoj)
sur chat-info (si le lien ne marche pas, identifiez-vous d'abord sur [chat-info](https://chat-info.univ-lyon1.fr)).

Ce TP devrait vous prendre environ une s√©ance.

## Environnement

Pour d√©velopper en Java durant le TP, il est fortement recommand√© d'utiliser, un
environnement de d√©veloppement int√©gr√© (comme VSCode, Eclipse, Netbeans ou
IntelliJ IDEA, etc) qui permet de compiler, de g√©n√©rer un projet, de d√©bugger et
d'ex√©cuter. 

Vous pouvez aussi choisir d'utiliser n'importe quel √©diteur de texte avec
coloration syntaxique, mais les outils que nous utilisons dans l'UE sont en
g√©n√©ral plus agr√©ables √† utiliser via l'int√©gration IDE.

Le TP n'a √©t√© test√© que sous Linux. Sur les machines de l'universit√© le TP fonctionne sous Linux, mais les IDE Java n'ont pas l'air install√©s sous Windows. Sur vos machines personnelles, vous pouvez utiliser l'OS de votre choix.

### Sur les machines du Nautibus sous Linux

Sur les machines du Nautibus, les TPs ont √©t√© test√©s sous Linux, en
utilisant l'environnement Java par d√©faut (sans rien configurer).

#### En cas de probl√®me avec l'environnement par d√©faut

En cas de besoin, il y a aussi une version install√© pour vous dans
`/home/tpetu/m1if01/` (√† une √©poque o√π la version par d√©faut posait
probl√®me). Pour l'utiliser (en cas de soucis avec la version de base),
avant de d√©marrer le TP, ajoutez ceci dans votre fichier `~/.bashrc`:

    PATH=/home/tpetu/m1if01/bin:"$PATH"

Puis rechargez le fichier (`exec bash` par exemple). V√©rifiez que vous
obtenez bien :

    $ which java
    /home/tpetu/m1if01/bin/java
    $ which javac
    /home/tpetu/m1if01/bin/javac
    $ which mvn
    /home/tpetu/m1if01/bin/mvn

### Sur vos machines personnelles

Sur vos machines personnelles, en cas de probl√®me sous Linux, il peut
√™tre n√©cessaire d'installer JavaFX explicitement (`sudo apt install
openjfx` sous Ubuntu, ou bien t√©l√©chargement depuis
[openjfx.io](https://openjfx.io)). Le TP a √©t√© test√© avec Java 11, il
ne marchera probablement pas sans adaptation avec des versions plus r√©centes
(il faudra peut-√™tre version de JavaFX dans `pom.xml`).

Si vous avez install√© JavaFX via votre distribution et que Java ne
trouve pas les classes JavaFX, ajoutez explicitement les fichiers JAR
concern√©s √† votre classpath, avec quelque chose comme :

    CLASSPATH="$CLASSPATH":/usr/share/java/openjfx/jre/lib/ext/jfxrt.jar
    CLASSPATH="$CLASSPATH":/usr/share/java/openjfx/jre/lib/jfxswt.jar
    export CLASSPATH

Sur machines personnelles, v√©rifiez que vous avez bien `git` et `mvn`
install√©s :

    $ git --version
    git version 2.17.0
    $ mvn --version
    Apache Maven 3.5.2
    [...]

(Vous pouvez bien s√ªr avoir des versions plus r√©centes)

Si ce n'est pas le cas installez-les. Sous Ubuntu, faire :

    apt install git maven

Si quelque chose ne marche pas, regardez si la solution n'est pas document√©e dans [FAQ.md](../FAQ.md).

## Cr√©ation d'un projet sur la forge et r√©cup√©ration du code

Ouvrez dans votre navigateur
[forge.univ-lyon1.fr](http://forge.univ-lyon1.fr). Si vous vous
connectez pour la premi√®re fois, le syst√®me vous permettra de
v√©rifier/modifier les informations qui vous concernent, idem pour
votre √©ventuel bin√¥me.

Nous allons utiliser le d√©p√¥t Git du cours comme base pour votre
projet. Ouvrez la page
[https://forge.univ-lyon1.fr/matthieu.moy/mif01-2022](https://forge.univ-lyon1.fr/matthieu.moy/mif01-2022),
et cliquez sur le bouton ¬´¬†fork¬†¬ª. Ce bouton vous permet de r√©cup√©rer
une copie du projet sur votre espace de la forge.

**IMPORTANT**: pour l'instant, le fork de votre projet est public sur
la forge. Nous vous demandons **imp√©rativement de passer ce projet en
¬´¬†priv√©¬†¬ª** pour que vos coll√®gues ne puissent pas recopier votre code.
En cas de copie, nous sanctionnerons s√©v√®rement les √©tudiants ayant copi√© **et**
ceux ayant laiss√© copier leur code. Pour rendre votre projet priv√©,
rendez-vous dans ¬´¬†settings ‚Üí general¬†¬ª en bas de la barre lat√©rale de
gauche, puis ¬´¬†Permissions¬†¬ª. Le premier r√©glage est ¬´¬†Project
visibility¬†¬ª. Dans le menu, choisissez ¬´¬†private¬†¬ª, puis cliquez sur
le bouton ¬´¬†save changes¬†¬ª.

Pour v√©rifier que votre projet est bien priv√© (indispensable),
retournez √† la page d'accueil de votre projet
(`https://forge.univ-lyon1.fr/votre.nom/mif01-2022`) et copiez l'URL.
Ouvrez une fen√™tre de navigation priv√©e
(<kbd>Control</kbd>+<kbd>Shift</kbd>+<kbd>P</kbd> sous Firefox,
<kbd>Control</kbd>+<kbd>Shift</kbd>+<kbd>N</kbd> sous Chrom{e,ium}), et collez l'URL de votre projet
dans la barre d'URL. Comme le projet est priv√©, vous devez avoir le
message ¬´¬†You need to sign in or sign up before continuing.¬†¬ª. Si ce
n'est pas le cas, vous avez rat√© quelque chose, recommencez la
manipulation.

Bien s√ªr, il faudra donner les droits √† vos enseignants, cf.
[projet-note.md](projet-note.md), et √† votre bin√¥me. Tout cela se fait dans
Configuration ‚Üí Membres.

Pour vos projets futurs, vous pourrez aussi cr√©er des projets √† partir
de z√©ro. Pour cela, vous pourrez faire simplement ¬´¬†new project¬†¬ª
(bouton **+** en haut de l'√©cran).

R√©cup√©rez une copie locale du code avec la commande (l'URL est √†
ajuster et vous est donn√©e par la forge quand vous ouvrez votre projet
avec votre navigateur) :

```
git clone https://forge.univ-lyon1.fr/votrelogin/mif01-2022.git
cd mif01-2022
```

[En cas de probl√®me, voir la FAQ de la forge](https://forge.univ-lyon1.fr/EMMANUEL.COQUERY/forge/wikis/FAQ).

Une fois le clone fait, indiquez l'URL de votre projet (la m√™me pour les deux
membres du bin√¥me) sur TOMUSS. Voir consignes d√©taill√©es dans
[projet-note.md](projet-note.md).

Ce fork est votre version du projet, c'est l√† que vous ferez votre d√©veloppement.
En cas de mise √†¬†jour du d√©p√¥t du cours, votre d√©p√¥t ne recevra pas
automatiquement les mises √† jour. Nous verrons au TP2 comment r√©cup√©rer facilement les mises √† jour depuis le d√©p√¥t enseignant.

## Premier contact avec le projet

On vous fournit un squelette [mes/](../mes/).

Le projet utilise l'outil Maven pour la compilation. Nous en parlerons
plus en d√©tails en CM, pour l'instant vous devez seulement savoir :

- Le projet est d√©crit dans le fichier `pom.xml`. Vous pouvez regarder
  le contenu de ce fichier mais vous n'avez pas besoin de le modifier
  pour ce TP.
  
- `mvn compile` compile le projet

- `mvn exec:java` lance le programme compil√©

V√©rifiez que vous pouvez lancer le programme depuis la ligne de
commande.

Le squelette contient ces classes :

-   `view.JfxView` : une classe g√©rant l'interface graphique. Vous pouvez jeter
    un ≈ìil au code source de cette classe et des classes qu'elle utilise
    (`PatientView`, `HealthProfessionalView`). Si vous trouvez le code propre,
    ce cours est l√† pour vous montrer que ce n'est pas le cas, il y a beaucoup
    de choses dans ce squelette qu'un bon programmeur ne fait *jamais*.

-   Des classes `model.*` : pour g√©rer pour vous les donn√©es manipul√©es par
    votre programme. Dans la vraie vie, il y aurait une vraie base de donn√©es,
    mais pour simplifier, tout est g√©r√© en RAM. Notre application manipule des
    patients (`Patient`), des professionnels de sant√© (`HealthProfessional`), et
    des ordonnances (`Prescription`), √©mises par des professionnels de sant√©
    pour des patients.

-   `App` : la principale, qui g√®re la cr√©ation de l'application.

Le squelette de code fait une premi√®re s√©paration entre l'interface
graphique (package `view`) et la logique m√©tier (package `model`).
Nous verrons plus tard que cette s√©paration est encore plus
qu'imparfaite et vous demanderons de refactorer le code.

### Exemple d'utilisation

Lancez l'interface graphique (`mvn exec:java`). Vous devriez voir s'afficher √†
gauche la liste des patients, et √† droite la liste des professionnels de sant√©.
Bien s√ªr, dans la vraie vie chaque utilisateur aurait son interface et ne verrai
pas les informations des autres utilisateurs, mais pour simplifier nous
affichons tout au m√™me endroit. Chaque patient voit la liste des ordonnances qui
le concernent, et chaque professionnel de sant√© peut chercher un patient en
utilisant son num√©ro de s√©curit√© sociale (pour simplifier, un bouton üìã permet
de copier le num√©ro de s√©curit√© sociale d'un patient, et vous pouvez le coller
avec <kbd>Control</kbd>+<kbd>v</kbd> dans le champ recherche. Avec un peu
d'imagination ce syst√®me est √©quivalent au lecteur de carte vitale de votre
m√©decin ...). Une fois un patient s√©lectionn√©, le professionnel de sant√© peut
ajouter ou supprimer des ordonnances. Une ordonnance est ici simplement une cha√Æne
de caract√®res, et le professionnel de sant√© a une s√©rie de boutons pour faire
une ordonnance en 1 clic plut√¥t que de devoir saisir l'intitul√© exact au
clavier.

Dans le vrai https://www.monespacesante.fr/, c'est bien entendu beaucoup plus
complexe. En r√©alit√©, le professionnel de sant√© cr√©e son ordonnance dans un
autre logiciel, qui lui permet de l'envoyer √† l'espace sant√© automatiquement.

Cliquez sur le bouton üìã de l'utilisatrice Alice, collez le num√©ro dans le champ
recherche de Dr. Who et validez. Vous devriez voir les ordonnances d'Alice
s'afficher. Essayez d'entrer ¬´ Prendre la pilule rouge ¬ª dans le champ ¬´
prescribe ¬ª puis validez. Vous devriez voir appara√Ætre cette ordonnance dans la
liste du Dr. Who, mais vous aurez besoin d'un clic sur üóò pour mettre √†¬†jour la
liste du c√¥t√© d'Alice.

(Hmm, hmm, non-seulement ce n'est pas tr√®s ergonomique, mais c'est r√©v√©lateur
d'un probl√®me d'architecture de notre squelette de code, la liste aurait du se
mettre √† jour toute seule ...)

Cliquez sur un bouton ¬´¬†x¬†¬ª en face d'une ordonnance : l'ordonnance est
supprim√©e.

### Documentation de Java et JavaFX

Consultez la documentation de [Java
11](https://docs.oracle.com/en/java/javase/11/docs/api/index.html) et de
[JavaFX Graphics](https://openjfx.io/javadoc/11/)
(la biblioth√®que graphique utilis√©e).

### Chargement du projet dans un IDE (VS Code, Eclipse, IntelliJ, Netbeans ..)

Si vous souhaitez utiliser un IDE, votre IDE favori propose
probablement une prise en charge de Maven, et configurera donc le
projet automatiquement depuis le `pom.xml` :

- VS Code : installer le plugin [Java Extension Pack](https://marketplace.visualstudio.com/items?itemName=vscjava.vscode-java-pack) qui apporte le support du langage Java, de Maven, ... Faire menu File ‚Üí Open Folder (<kbd>Controle</kbd>+<kbd>k</kbd> <kbd>Controle</kbd>+<kbd>o</kbd>) puis choisir le r√©pertoire. Une section ¬´¬†Maven Projects ¬ª doit s'ajouter √† la barre lat√©rale de gauche, et vous pourrez s√©lectionner les actions √† effectuer (`exec:java` dans la section `exec` pour lancer l'application). Si vous n'avez pas la compl√©tion intelligente et la navigation dans le code, vous devrez sans doute positionner votre variable de configuration `java.home` : faire avec <kbd>Control</kbd> + <kbd>,</kbd>, puis chercher `java.home` et ¬´¬†edit in settings.json¬†¬ª. Au Nautibus, la configuration est :
<pre>
"java.home" : "/home/tpetu/m1if01/jdk-11.0.4/"
</pre>

- Eclipse : installer le plugin [m2e](http://www.eclipse.org/m2e/), puis importer le projet en
  temps que projet Maven (File ‚Üí Import... ‚Üí Maven ‚Üí Existing Maven Projects). Au Nautibus, Eclipse
  est install√© dans `/home/tpetu/m1if01/bin/eclipse` avec m2e install√©. Pour lancer l'application,
  on peut au choix utiliser ¬´¬†Run as ...¬†¬ª¬†‚Üí ¬´¬†Java application¬†¬ª (mais cf. ci-dessous pour une
  erreur fr√©quente), ou ¬´¬†Run as ... ¬ª ‚Üí ¬´¬†Maven Build...¬†¬ª puis choisir le goal ¬´¬†exec:java¬†¬ª.

- IntelliJ et Netbeans : le support de Maven est inclus de base dans l'outil. Il
  suffit d'ouvrir le r√©pertoire contenant le `pom.xml`.

Il n'est pas rare qu'il y ait de mauvaises interactions entre un IDE et JavaFX, nous avons essay√© de documenter les probl√®mes et solutions dans [FAQ.md](../FAQ.md).

## Travail demand√©

Dans un premier temps, conservez l'architecture (r√©partition en
classes et packages) fournie. Nous verrons bient√¥t comment r√©organiser
le tout.

### Un autre type de professionnel de sant√©

Pour l'instant, un professionnel de sant√© peut √™tre soit non-sp√©cialis√©, soit
Hom√©opathe, soit Dentiste (dans le mod√®le, ceci est refl√©t√© par de l'h√©ritage,
les classes `Homeopath` et `Dentist` d√©rivent de `HealthProfessionnal`). Ajoutez
un autre type de soignant en cr√©ant une classe similaire √†¬†`Homeopath` et
`Dentist`. Instanciez cette classe dans
`model.MES.createExampleConfiguration()`, et proposez des boutons pour ajouter
les prescriptions en un clic correspondant √† ce type de soignant (il n'est pas
demand√© que ce soit r√©aliste m√©dicalement !).

Si vous ne trouvez pas les endroits o√π¬†faire les modifications dans la base de
code, une astuce : cherchez les cha√Ænes de caract√®res qui vous int√©ressent, par
exemple `git grep Natrum` vous indiquera o√π se trouve la prescription pr√©d√©finie
de l'Hom√©opathe.

### Ajout dynamique de patient

En bas de la liste des patients, vous avez un bouton qui devrait permettre de
cr√©er un patient. Dans le squelette, cette fonctionnalit√© n'est pas impl√©ment√©e
(il y a presque tout ce qu'il faut dans `MES.java`, mais ce n'est pas expos√©
dans l'interface graphique). Ajoutez le n√©cessaire pour que ce bouton
fonctionne.

### Suppression d'une ordonnance par un patient

Pour des raisons de confidentialit√©, un patient pourrait vouloir supprimer une ordonnance. R√©fl√©chissez √† ce qu'il faudrait faire pour avoir un bouton ¬´ x¬†¬ª dans la liste des ordonnances d'un patient, analogue au bouton ¬´ x ¬ª d√©j√† pr√©sent chez les professionnels de sant√©. Si vous pensez pouvoir le faire facilement, codez-le, mais vous pouvez aussi d√©cider que cette modification est trop horrible pour √™tre faite sur la base de code en l'√©tat, et attendre d'avoir fait un refactoring MVC correct pour impl√©menter cette fonctionnalit√©.

### Probl√®mes avec la base de code fournie

R√©fl√©chissez maintenant √† l'architecture du code. Posez-vous les
questions (rh√©toriques ?) suivantes :

- Est-ce facile de modifier l'interface graphique sans changer la
  fonctionnalit√© ?
  
- √Ä l'inverse, des fonctionnalit√©s comme les ordonnances pr√©-d√©finies devraient
  √™tre ind√©pendantes, ou presque, de l'interface graphique utilis√©e. Quand vous
  avez ajout√© un type de professionnel de sant√©, avez-vous pu le faire sans
  modifier la vue ?
  
- Si vous deviez avoir plusieurs interfaces possibles (par exemple un
  mode ¬´¬†expert¬†¬ª et un mode ¬´¬†d√©butant¬†¬ª avec moins de boutons, ou
  une interface web et une interface graphique JavaFX), pourriez-vous
  le faire facilement sans dupliquer le code de la logique m√©tier ?
  
- Quelles sont les responsabilit√©s de la classe `JfxView` ? Est-ce
  compatible avec le [Principe de Responsabilit√©
  Unique](https://en.wikipedia.org/wiki/Single_responsibility_principle) ?

Quelques √©l√©ments de r√©ponses sont disponibles dans le fichier
[architecture-et-dependances.md](architecture-et-dependances.md). Ne
les lisez pas avant d'y avoir r√©fl√©chi vous-m√™mes.

## Si vous avez fini ...

Passez au [TP2](../TP2-outils) !
